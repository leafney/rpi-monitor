name: Push for Lint

on:
  push:
    tags-ignore:
      - "v*"
  pull_request:
    branches:
      - main
      - dev


jobs:
  test:
    name: Lint and Test
    runs-on: ubuntu-latest
    env:
      PROJECT_NAME: rpi-monitor
    steps:
      - uses: actions/setup-go@v3
        with:
          go-version: 1.17

      - uses: actions/checkout@v3

      - name: tidy
        run: go mod tidy

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: v1.50.1

      - name: test
        run: go test -v ./...

      - name: Send Success Notify
        uses: leafney/dingtalk-action@v1
        if: always()
        env:
          DINGTALK_ACCESS_TOKEN: ${{ secrets.DINGTALK_ACCESS_TOKEN }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
        with:
          msgtype: markdown
          notify_when: 'success'
          title: '[${{ env.PROJECT_NAME }}] ä»£ç è§„èŒƒæ£€æŸ¥åˆæ ¼'
          text: |
            **<font color=#56A6FE size=3> ğŸ‰${{ env.PROJECT_NAME }}ğŸ‰ Lintåˆæ ¼</font>**

            Action **[${{ github.workflow }}]** ä»£ç è§„èŒƒæ£€æŸ¥åˆæ ¼

      - name: Send Failure Notify
        uses: leafney/dingtalk-action@v1
        if: always()
        env:
          DINGTALK_ACCESS_TOKEN: ${{ secrets.DINGTALK_ACCESS_TOKEN }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
        with:
          msgtype: markdown
          notify_when: 'failure'
          title: '[${{ env.PROJECT_NAME }}] ä»£ç è§„èŒƒæ£€æŸ¥å‘ç°å¼‚å¸¸'
          text: |
            **<font color=#FF0000 size=3> ğŸŒ´${{ env.PROJECT_NAME }}ğŸŒ´ Lintå¤±è´¥</font>**

            Action **[${{ github.workflow }}]** ä»£ç è§„èŒƒæ£€æŸ¥å‘ç°å¼‚å¸¸

            [æŸ¥çœ‹é”™è¯¯ä¿¡æ¯](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
